syntax = "proto3";

package rollup.v1;

option go_package = "github.com/ethereum/go-ethereum/internal/rollup-shared-publisher/proto/rollup/v1;rollupv1";

// Connection-level authentication handshake messages
message HandshakeRequest {
  int64 timestamp = 1;           // Client timestamp for replay protection
  bytes public_key = 2;          // Client's public key (33 bytes compressed)
  bytes signature = 3;           // ECDSA signature over timestamp
  string client_id = 4;          // Optional client identifier
  bytes nonce = 5;           // Random nonce for replay protection
}

message HandshakeResponse {
  bool accepted = 1;             // Whether authentication succeeded
  string error = 2;              // Error message if rejected
  string session_id = 3;         // Unique session identifier
}

// Connection health check messages
message Ping {
  int64 timestamp = 1; // Timestamp for latency measurement
}

message Pong {
  int64 timestamp = 1; // Echo back the timestamp from Ping
}

// =============================================================================
// SYNCHRONOUS COMPOSABILITY PROTOCOL (SCP) MESSAGES
// =============================================================================

// It's used that InstanceID <- hash(period_id + sequence_number + xt_request)

// Cross-chain transaction request
message XTRequest { // from User
  repeated bytes transactions = 1; // List of RLP encoded Ethereum transactions
}

// Message to start cross-chain transaction coordination
message StartInstance {
  uint64 period_id = 1; // Current period ID
  uint64 sequence_number = 2; // Sequence number for ordering within the period
  XTRequest xt_request = 3; // The cross-chain transaction request
}

// 2PC Vote message from a sequencer to the SP
message Vote {
  hash instance_id = 1; // Instance ID
  uint64 chain_id = 2; // Which chain is voting
  bool vote = 3; // true = Commit, false = Abort
}

// 2PC Decision message from the SP to sequencers
message Decided {
  hash instance_id = 1; // Instance ID
  bool decision = 2; // true = Commit, false = Abort
}

// Direct Mailbox message exchange between sequencers (without SP involvement)
message MailboxMessage {
  hash instance_id = 1; // Instance ID
  uint64 source_chain = 2;
  uint64 destination_chain = 3;
  bytes source = 3;
  bytes receiver = 4;
  uint64 session_id = 5;
  string label = 6;
  repeated bytes data = 7; // ABI encoded data
}

// =============================================================================
// SUPERBLOCK CONSTRUCTION PROTOCOL V2 (SBCP) MESSAGES
// =============================================================================


// Message sent by SP to start a new period
message StartPeriod {
  uint64 period_id = 1; // New period id
  uint64 superblock_number = 2; // Superblock number SP aims to produce
}

// Message sent by SP to rollback and restart from a valid state
message Rollback {
  uint64 period_id = 1; // Current period id
  uint64 last_finalized_superblock_number = 2; // Last finalized superblock number
  hash last_finalized_superblock_hash = 3; // Last finalized superblock hash
}

// =============================================================================
// CROSS-DOMAIN COMPOSABILITY PROTOCOL (CDCP) NEW MESSAGES
// =============================================================================

// Uses StartInstance, MailboxMessage, Vote, Decided defined above

// SP sends to the WS after collecting votes
message NativeDecided {
  hash instance_id = 1;
  bool decision = 2;
}

// WS sends to the SP after getting the response from ER client
message WSDecided {
  hash instance_id = 1;
  bool decision = 2;
}

// Wrapper for all messages
// FIXME
message Message {
  string sender_id = 1; // Identifier of the sender
  // Payload contains the actual message content
  oneof payload {
    XTRequest xt_request = 2;
    Vote vote = 3;
    Decided decided = 4;
    Block block = 5;
    CIRCMessage circ_message = 6;

    // SBCP messages
    StartSlot start_slot = 7;
    RequestSeal request_seal = 8;
    RollBackAndStartSlot roll_back_and_start_slot = 9;
    L2Block l2_block = 10;
    StartSC start_sc = 11;

    // Connection-level authentication
    HandshakeRequest handshake_request = 12;
    HandshakeResponse handshake_response = 13;

    // Connection health check
    Ping ping = 14;
    Pong pong = 15;

    // CDCP
    StartCDCP start_cdcp = 16;
    NativeDecided native_decided = 17;
    WSDecided ws_decided = 18;
  }
}
